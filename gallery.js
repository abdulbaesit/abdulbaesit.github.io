(function () {
    // Auto-generated list of all JPG/JPEG images found in the repository.
    // If you add new images, append to this array (type, path, title derived from filename).
    const MEDIA_ITEMS = [
        { type: 'image', path: 'assets/me.jpg', title: 'me' },
        { type: 'image', path: 'assets/a lot of me/100803.JPEG', title: '100803' },
        { type: 'image', path: 'assets/a lot of me/100808.JPEG', title: '100808' },
        { type: 'image', path: 'assets/a lot of me/101422.JPEG', title: '101422' },
        { type: 'image', path: 'assets/a lot of me/101608.jpg', title: '101608' },
        { type: 'image', path: 'assets/a lot of me/101670.JPEG', title: '101670' },
        { type: 'image', path: 'assets/a lot of me/101714.JPEG', title: '101714' },
        { type: 'image', path: 'assets/a lot of me/101786.jpg', title: '101786' },
        { type: 'image', path: 'assets/a lot of me/183cf342-dee4-487f-9ac1-835e649cacc7.JPG', title: '183cf342-dee4-487f-9ac1-835e649cacc7' },
        { type: 'image', path: 'assets/a lot of me/1C80556E-E676-4B3F-B80C-B8A024C8CD37.JPG', title: '1C80556E-E676-4B3F-B80C-B8A024C8CD37' },
        { type: 'image', path: 'assets/a lot of me/76401.JPEG', title: '76401' },
        { type: 'image', path: 'assets/a lot of me/76404.JPEG', title: '76404' },
        { type: 'image', path: 'assets/a lot of me/BASIT FOR PRESI.jpg', title: 'BASIT FOR PRESI' },
        { type: 'image', path: 'assets/a lot of me/IMG_0271.jpg', title: 'IMG_0271' },
        { type: 'image', path: 'assets/a lot of me/IMG_0827.jpg', title: 'IMG_0827' },
        { type: 'image', path: 'assets/a lot of me/IMG_0992.JPG', title: 'IMG_0992' },
        { type: 'image', path: 'assets/a lot of me/IMG_1008.jpg', title: 'IMG_1008' },
        { type: 'image', path: 'assets/a lot of me/IMG_1250.jpg', title: 'IMG_1250' },
        { type: 'image', path: 'assets/a lot of me/IMG_2144.jpg', title: 'IMG_2144' },
        { type: 'image', path: 'assets/a lot of me/IMG_2333.jpg', title: 'IMG_2333' },
        { type: 'image', path: 'assets/a lot of me/IMG_2857.jpg', title: 'IMG_2857' },
        { type: 'image', path: 'assets/a lot of me/IMG_2954.jpg', title: 'IMG_2954' },
        { type: 'image', path: 'assets/a lot of me/IMG_3312.jpg', title: 'IMG_3312' },
        { type: 'image', path: 'assets/a lot of me/IMG_3359.jpg', title: 'IMG_3359' },
        { type: 'image', path: 'assets/a lot of me/IMG_3383.jpg', title: 'IMG_3383' },
        { type: 'image', path: 'assets/a lot of me/IMG_3604.JPG', title: 'IMG_3604' },
        { type: 'image', path: 'assets/a lot of me/IMG_3668.jpg', title: 'IMG_3668' },
        { type: 'image', path: 'assets/a lot of me/IMG_3678.jpg', title: 'IMG_3678' },
        { type: 'image', path: 'assets/a lot of me/IMG_4628.jpg', title: 'IMG_4628' },
        { type: 'image', path: 'assets/a lot of me/IMG_4902.jpg', title: 'IMG_4902' },
        { type: 'image', path: 'assets/a lot of me/IMG_5052.jpg', title: 'IMG_5052' },
        { type: 'image', path: 'assets/a lot of me/IMG_5188.jpg', title: 'IMG_5188' },
        { type: 'image', path: 'assets/a lot of me/IMG_5234.jpg', title: 'IMG_5234' },
        { type: 'image', path: 'assets/a lot of me/IMG_5513.jpg', title: 'IMG_5513' },
        { type: 'image', path: 'assets/a lot of me/IMG_5523.jpg', title: 'IMG_5523' },
        { type: 'image', path: 'assets/a lot of me/IMG_5538.jpg', title: 'IMG_5538' },
        { type: 'image', path: 'assets/a lot of me/IMG_5545.jpg', title: 'IMG_5545' },
        { type: 'image', path: 'assets/a lot of me/IMG_5553.jpg', title: 'IMG_5553' },
        { type: 'image', path: 'assets/a lot of me/IMG_5557.jpg', title: 'IMG_5557' },
        { type: 'image', path: 'assets/a lot of me/IMG_5562.jpg', title: 'IMG_5562' },
        { type: 'image', path: 'assets/a lot of me/IMG_5778.jpg', title: 'IMG_5778' },
        { type: 'image', path: 'assets/a lot of me/IMG_5790.jpg', title: 'IMG_5790' },
        { type: 'image', path: 'assets/a lot of me/IMG_5983.jpg', title: 'IMG_5983' },
        { type: 'image', path: 'assets/a lot of me/IMG_6008.jpg', title: 'IMG_6008' },
        { type: 'image', path: 'assets/a lot of me/IMG_6013.jpg', title: 'IMG_6013' },
        { type: 'image', path: 'assets/a lot of me/IMG_6213.jpg', title: 'IMG_6213' },
        { type: 'image', path: 'assets/a lot of me/IMG_6279.jpg', title: 'IMG_6279' },
        { type: 'image', path: 'assets/a lot of me/IMG_6347.jpg', title: 'IMG_6347' },
        { type: 'image', path: 'assets/a lot of me/IMG_6713.jpg', title: 'IMG_6713' },
        { type: 'image', path: 'assets/a lot of me/IMG_6721.JPG', title: 'IMG_6721' },
        { type: 'image', path: 'assets/a lot of me/IMG_6773.jpg', title: 'IMG_6773' },
        { type: 'image', path: 'assets/a lot of me/IMG_6784.jpg', title: 'IMG_6784' },
        { type: 'image', path: 'assets/a lot of me/IMG_7729.jpg', title: 'IMG_7729' },
        { type: 'image', path: 'assets/a lot of me/IMG_8119.jpg', title: 'IMG_8119' },
        { type: 'image', path: 'assets/a lot of me/IMG_8518.jpg', title: 'IMG_8518' },
        { type: 'image', path: 'assets/a lot of me/IMG_8937.jpg', title: 'IMG_8937' },
        { type: 'image', path: 'assets/a lot of me/IMG_9048.jpg', title: 'IMG_9048' },
        { type: 'image', path: 'assets/a lot of me/IMG_9178.jpg', title: 'IMG_9178' },
        { type: 'image', path: 'assets/a lot of me/IMG_9327.jpg', title: 'IMG_9327' },
        { type: 'image', path: 'assets/a lot of me/IMG_9395.jpg', title: 'IMG_9395' },
        { type: 'image', path: 'assets/a lot of me/PXL_20250124_121047239.JPG', title: 'PXL_20250124_121047239' },
        { type: 'image', path: 'assets/a lot of me/PXL_20250925_132549138.JPG', title: 'PXL_20250925_132549138' },
        { type: 'image', path: 'assets/a lot of me/PXL_20250925_133024898.jpg', title: 'PXL_20250925_133024898' },
        { type: 'image', path: 'assets/a lot of me/a3c88947-fe20-4e5e-b5d3-719a98b3d5ba.JPG', title: 'a3c88947-fe20-4e5e-b5d3-719a98b3d5ba' },
        { type: 'video', path: 'assets/a lot of me/vIMG_9181.MOV', title: 'vIMG_9181' }
    ]; const grid = document.getElementById('gallery-grid');
    const loadBtn = document.getElementById('load-media-btn');
    const filterBtns = document.querySelectorAll('.gallery-btn[data-filter]');

    let hasLoaded = false;
    let currentFilter = 'all';

    // Optional autoload: support URL hash/query or stored preference.
    // Use #load or ?load=1 to autoload the gallery (keeps default privacy otherwise).
    const url = new URL(window.location.href);
    const autoLoad = (
        (url.hash && url.hash.toLowerCase().includes('load')) ||
        (url.searchParams && (url.searchParams.has('load') || url.searchParams.get('autoload') === '1')) ||
        localStorage.getItem('galleryAutoload') === '1'
    );

    function encodePath(p) {
        // Encode each segment to avoid issues with spaces or special chars
        return p.split('/').map(encodeURIComponent).join('/');
    }

    async function heicToJpegObjectUrl(url) {
        try {
            // Ensure heic2any is available
            if (typeof heic2any !== 'function') return null;

            const res = await fetch(encodePath(url));
            if (!res.ok) throw new Error('Failed to fetch HEIC');
            const blob = await res.blob();
            // Convert to JPEG for widest compatibility
            const outBlob = await heic2any({ blob, toType: 'image/jpeg', quality: 0.9 });
            // heic2any can return a single Blob or an array
            const jpegBlob = Array.isArray(outBlob) ? outBlob[0] : outBlob;
            return URL.createObjectURL(jpegBlob);
        } catch (e) {
            console.warn('HEIC conversion failed:', e);
            return null;
        }
    }

    function createCard(item, index) {
        const card = document.createElement('div');
        card.className = 'gallery-item';
        card.dataset.type = item.type;

        const inner = document.createElement('div');
        inner.className = 'gallery-inner';

        const overlay = document.createElement('div');
        overlay.className = 'overlay';
        overlay.textContent = item.title || '';

        if (item.type === 'image') {
            if (item.heic) {
                const note = document.createElement('div');
                note.className = 'heic-note';
                note.textContent = 'Converting HEIC… (will auto-open if supported)';
                inner.appendChild(note);

                const link = document.createElement('a');
                link.href = encodePath(item.path);
                link.download = '';
                link.className = 'heic-download';
                link.textContent = 'Download HEIC';
                inner.appendChild(link);

                const img = document.createElement('img');
                img.loading = 'lazy';
                img.decoding = 'async';
                img.alt = item.title || 'HEIC image';
                inner.appendChild(img);

                // Try client-side conversion for cross-browser preview
                heicToJpegObjectUrl(item.path).then((objectUrl) => {
                    if (objectUrl) {
                        img.src = objectUrl;
                        note.textContent = item.title || 'HEIC (converted)';
                    } else {
                        // As a fallback, attempt direct display (Safari may show it).
                        img.src = encodePath(item.path);
                        note.textContent = 'HEIC — may not preview; use Download';
                    }
                });
                card.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); openLightbox(index); });
            } else {
                const img = document.createElement('img');
                img.loading = 'lazy';
                img.decoding = 'async';
                img.alt = item.title || 'image';
                img.src = encodePath(item.path);
                img.onerror = () => {
                    console.warn('Image failed to load:', item.path);
                    img.classList.add('img-error');
                    img.alt = item.title + ' (failed to load)';
                };
                inner.appendChild(img);
                card.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); openLightbox(index); });
            }
        } else if (item.type === 'video') {
            const video = document.createElement('video');
            video.controls = false;
            video.muted = true;
            video.playsInline = true;
            video.preload = 'none';
            video.poster = '';
            const src = document.createElement('source');
            src.src = encodePath(item.path);
            video.appendChild(src);
            inner.appendChild(video);
            card.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); openLightbox(index); });
        }

        // add overlay caption (visible on hover)
        if (item.title) {
            card.appendChild(overlay);
        }

        card.appendChild(inner);
        return card;
    }

    function render(filter) {
        if (!grid) return;
        grid.innerHTML = '';
        currentItems = MEDIA_ITEMS.filter(it => filter === 'all' || it.type === filter);
        if (currentItems.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'gallery-empty';
            empty.textContent = 'No media to show.';
            grid.appendChild(empty);
            return;
        }
        const frag = document.createDocumentFragment();
        currentItems.forEach((it, index) => frag.appendChild(createCard(it, index)));
        grid.appendChild(frag);
    }

    // Lightbox
    const lightbox = document.getElementById('lightbox');
    const lightboxContent = document.getElementById('lightbox-content');
    const lightboxClose = document.querySelector('.lightbox-close');
    const prevBtn = document.querySelector('.lightbox-prev');
    const nextBtn = document.querySelector('.lightbox-next');

    let currentIndex = -1;
    let currentItems = []; // Currently filtered items
    let _lastFocusedElement = null; // store focus to restore after closing lightbox

    function openLightbox(index) {
        currentIndex = index;
        updateLightbox();
        // save previous focus to restore when closing
        _lastFocusedElement = document.activeElement;

        if (lightbox) {
            // force overlay behavior in case global CSS interferes
            lightbox.style.position = 'fixed';
            lightbox.style.inset = '0';
            lightbox.style.display = 'flex';
            lightbox.style.alignItems = 'center';
            lightbox.style.justifyContent = 'center';
            lightbox.style.zIndex = '99999';
            lightbox.style.background = 'rgba(0, 0, 0, 0.85)';
            lightbox.setAttribute('aria-hidden', 'false');
            lightbox.classList.add('open');

            // Reset any transient styles from touch interactions
            if (lightboxContent) {
                const child = lightboxContent.querySelector('img, video');
                if (child) {
                    child.style.transform = '';
                }
            }

            // move focus to the close button for accessibility/keyboard handling (deferred so element is focusable)
            const closeBtn = document.querySelector('.lightbox-close');
            if (closeBtn) {
                closeBtn.tabIndex = 0;
                setTimeout(() => closeBtn.focus(), 0);
            }
        }
        // ensure we're scrolled to top so overlay covers everything
        try { window.scrollTo({ top: 0, behavior: 'auto' }); } catch (e) { window.scrollTo(0, 0); }
        document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
        if (lightbox) {
            lightbox.setAttribute('aria-hidden', 'true');
            lightbox.classList.remove('open');
            // ensure any inline styles set when opening are cleared so CSS rules take effect
            try {
                lightbox.style.display = 'none';
                lightbox.style.background = '';
                lightbox.style.zIndex = '';
                lightbox.style.position = '';
                lightbox.style.inset = '';
                lightbox.style.alignItems = '';
                lightbox.style.justifyContent = '';
            } catch (e) { /* ignore */ }
        }

        if (lightboxContent) {
            const child = lightboxContent.querySelector('img, video');
            if (child) child.style.transform = '';
            lightboxContent.innerHTML = '';
        }

        // restore body scroll
        document.body.style.overflow = '';
        currentIndex = -1;

        // restore focus to whatever had focus before opening
        try {
            if (_lastFocusedElement && typeof _lastFocusedElement.focus === 'function') {
                _lastFocusedElement.focus();
            }
        } catch (e) {
            // ignore focus restore errors
        }
        _lastFocusedElement = null;

        // make close button non-focusable again
        const closeBtn = document.querySelector('.lightbox-close');
        if (closeBtn) closeBtn.tabIndex = -1;
    }

    function updateLightbox() {
        if (currentIndex < 0 || currentIndex >= currentItems.length) return;
        if (!lightboxContent) return;

        const item = currentItems[currentIndex];
        lightboxContent.innerHTML = '';

        if (item.type === 'image') {
            const img = document.createElement('img');
            img.src = encodePath(item.path);
            img.alt = item.title || '';
            // constrain image to viewport so it doesn't overflow and push below the fold
            img.style.maxWidth = 'calc(100vw - 80px)';
            img.style.maxHeight = 'calc(100vh - 80px)';
            img.style.width = 'auto';
            img.style.height = 'auto';
            lightboxContent.appendChild(img);
        } else if (item.type === 'video') {
            const video = document.createElement('video');
            video.controls = true;
            video.autoplay = true;
            video.playsInline = true;
            const source = document.createElement('source');
            source.src = encodePath(item.path);
            video.appendChild(source);
            video.style.maxWidth = 'calc(100vw - 80px)';
            video.style.maxHeight = 'calc(100vh - 80px)';
            lightboxContent.appendChild(video);
        }

        if (item.title) {
            const cap = document.createElement('div');
            cap.className = 'lightbox-caption';
            cap.textContent = item.title;
            lightboxContent.appendChild(cap);
        }

        // Update nav buttons visibility
        if (prevBtn) prevBtn.style.display = currentIndex > 0 ? 'flex' : 'none';
        if (nextBtn) nextBtn.style.display = currentIndex < currentItems.length - 1 ? 'flex' : 'none';
    }

    function showNext() {
        if (currentIndex < currentItems.length - 1) {
            currentIndex++;
            updateLightbox();
        }
    }

    function showPrev() {
        if (currentIndex > 0) {
            currentIndex--;
            updateLightbox();
        }
    }

    if (lightboxClose) lightboxClose.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); closeLightbox(); });
    if (prevBtn) prevBtn.addEventListener('click', (e) => { e.stopPropagation(); showPrev(); });
    if (nextBtn) nextBtn.addEventListener('click', (e) => { e.stopPropagation(); showNext(); });

    if (lightbox) {
        // Overlay clicks intentionally do NOT close the lightbox.
        // Closing will happen only via the close button (✕) or the Escape key.
        lightbox.addEventListener('click', (e) => {
            // no-op by design
        });
    }

    document.addEventListener('keydown', (e) => {
        if (!lightbox || lightbox.getAttribute('aria-hidden') === 'true') return;
        if (e.key === 'Escape' || e.key === 'Esc') { e.preventDefault(); closeLightbox(); }
        if (e.key === 'ArrowLeft') { e.preventDefault(); showPrev(); }
        if (e.key === 'ArrowRight') { e.preventDefault(); showNext(); }
    });

    // Touch gestures for iOS-like experience
    let touchStartX = 0;
    let touchStartY = 0;
    let isDragging = false;

    if (lightbox) {
        lightbox.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
            isDragging = true;
            lightbox.classList.add('dragging');
        }, { passive: true });

        lightbox.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            const currentY = e.changedTouches[0].screenY;
            const diffY = currentY - touchStartY;

            // Visual feedback for swipe down to close
            if (diffY > 0) {
                const img = lightboxContent && lightboxContent.querySelector ? lightboxContent.querySelector('img, video') : null;
                if (img) {
                    const scale = 1 - (diffY / 1000); // Slight shrink
                    img.style.transform = `translateY(${diffY}px) scale(${scale})`;
                    lightbox.style.background = `rgba(0, 0, 0, ${Math.max(0, 0.95 - (diffY / 500))})`;
                }
            }
        }, { passive: true });

        lightbox.addEventListener('touchend', (e) => {
            const touchEndX = e.changedTouches[0].screenX;
            const touchEndY = e.changedTouches[0].screenY;
            isDragging = false;
            lightbox.classList.remove('dragging');

            const diffX = touchEndX - touchStartX;
            const diffY = touchEndY - touchStartY;

            // Reset styles
            const img = lightboxContent && lightboxContent.querySelector ? lightboxContent.querySelector('img, video') : null;
            if (img) {
                img.style.transform = '';
            }
            lightbox.style.background = '';

            // Swipe Down to Close intentionally disabled; closing only allowed via ESC or close button.

            // Horizontal Swipes (threshold 50px) for navigation
            if (Math.abs(diffX) > 50 && Math.abs(diffY) < 100) {
                if (diffX > 0) showPrev();
                else showNext();
            }
        }, { passive: true });
    }

    // Controls
    if (loadBtn) {
        loadBtn.addEventListener('click', () => {
            if (hasLoaded) return;
            hasLoaded = true;
            render(currentFilter);
            loadBtn.textContent = 'Loaded';
            loadBtn.disabled = true;
        });
    }

    // If autoload requested, render immediately without waiting for click
    if (autoLoad && !hasLoaded) {
        hasLoaded = true;
        render(currentFilter);
        if (loadBtn) {
            loadBtn.textContent = 'Loaded';
            loadBtn.disabled = true;
        }
    }

    function setActiveFilterButton() {
        filterBtns.forEach(b => b.classList.toggle('active', b.dataset.filter === currentFilter));
    }

    filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            currentFilter = btn.dataset.filter;
            if (hasLoaded) {
                render(currentFilter);
            }
            // active state
            setActiveFilterButton();
        });
    });

    // Ensure one of the filter buttons is active on initial load
    setActiveFilterButton();

    // Auto-load by default so the gallery is not blank
    if (!hasLoaded) {
        hasLoaded = true;
        render(currentFilter);
        if (loadBtn) {
            loadBtn.textContent = 'Loaded';
            loadBtn.disabled = true;
        }
    }
})();
